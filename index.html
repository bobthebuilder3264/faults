<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ffffff" />
  <title>Aircraft Fault Guide</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    .btn { margin: 5px; padding: 8px 12px; border-radius: 5px; cursor: pointer; background: #ddd; }
    .badge { font-weight: bold; color: white; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
    .advisory-badge { background-color: cyan; color: black; }
    .caution-badge { background-color: orange; }
    .warning-badge { background-color: red; }
    .fault { margin: 8px 0; padding: 8px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; }
    .hidden { display: none; }
    #backAircraftBtn { margin-bottom: 10px; display: block; }
  </style>
</head>
<body>

<h1 id="header">Aircraft Fault Guide</h1>

<div id="aircraftSelect"></div>

<div id="controls" class="hidden">
  <button class="btn" id="backAircraftBtn" onclick="goBackToAircraft()">← Back to Aircraft Type</button>
  <input type="text" id="search" placeholder="Search faults..." />
  <button class="btn" onclick="sortByLevel()">Sort by Level</button>
  <button class="btn" onclick="sortByATA()">Sort by ATA</button>
  <button class="btn" onclick="resetSort()">Reset Sort</button>
</div>

<div id="faultList"></div>
<div id="faultDetails" class="hidden"></div>

<script>
const SHEET_ID = '1_iMw2vlZMdcb4aOcauyyO1gRQiIHIVCN_BeJraJ0rTg';
const TABS = ['5000', '6500'];
let currentData = [];
let currentTab = '';

function fetchSheet(tabName) {
  currentTab = tabName;
  const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${tabName}`;
  fetch(URL)
    .then(res => res.text())
    .then(text => {
      const json = JSON.parse(text.substr(47).slice(0, -2));
      currentData = json.table.rows.map(r => {
        const c = r.c.map(e => e ? e.v.toString().trim() : '');
        return {
          code: c[0],
          title: c[1],
          description: c[2],
          cause: c[3],
          cb: c[4],
          level: c[5],
          ata: c[6]
        };
      });
      document.getElementById('header').textContent = `Aircraft Type: ${tabName} Faults`;
      showFaultList(currentData);
    });
}

function showAircraftSelect() {
  const div = document.getElementById('aircraftSelect');
  div.innerHTML = '<h3>Select Aircraft Type:</h3>';
  TABS.forEach(tab => {
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = tab;
    btn.onclick = () => {
      fetchSheet(tab);
      div.classList.add('hidden');
      document.getElementById('controls').classList.remove('hidden');
    };
    div.appendChild(btn);
  });
}

function showFaultList(data) {
  const list = document.getElementById('faultList');
  list.classList.remove('hidden');
  list.innerHTML = '';
  data.forEach(item => {
    const badge = getLevelBadge(item.level);
    const div = document.createElement('div');
    div.className = 'fault';
    div.innerHTML = `${badge}<strong>[${item.code}]</strong> ${item.title} <em>(ATA ${item.ata})</em>`;
    div.onclick = () => showDetails(item);
    list.appendChild(div);
  });
}

function getLevelBadge(level) {
  const lvl = level.toLowerCase();
  if (lvl.includes('advisory')) return '<span class="badge advisory-badge">A</span>';
  if (lvl.includes('caution')) return '<span class="badge caution-badge">C</span>';
  if (lvl.includes('warning')) return '<span class="badge warning-badge">W</span>';
  return '';
}

function showDetails(item) {
  document.getElementById('faultList').classList.add('hidden');
  document.getElementById('controls').classList.add('hidden');
  const details = document.getElementById('faultDetails');
  details.classList.remove('hidden');
  details.innerHTML = `
    <button class="btn" onclick="goBack()">← Back</button>
    <h2>${item.code} - ${item.title}</h2>
    <p><strong>Description:</strong> ${item.description}</p>
    <p><strong>Cause:</strong> ${item.cause}</p>
    <p><strong>CB:</strong> ${item.cb}</p>
    <p><strong>Level:</strong> ${getLevelBadge(item.level)} ${item.level}</p>
    <p><strong>ATA:</strong> ${item.ata}</p>
  `;
}

function goBack() {
  document.getElementById('faultDetails').classList.add('hidden');
  document.getElementById('faultList').classList.remove('hidden');
  document.getElementById('controls').classList.remove('hidden');
}

function goBackToAircraft() {
  currentData = [];
  currentTab = '';
  document.getElementById('header').textContent = 'Aircraft Fault Guide';
  document.getElementById('aircraftSelect').classList.remove('hidden');
  document.getElementById('controls').classList.add('hidden');
  document.getElementById('faultList').classList.add('hidden');
  document.getElementById('faultList').innerHTML = '';
}

function sortByLevel() {
  const sorted = [...currentData].sort((a, b) => a.level.localeCompare(b.level));
  showFaultList(sorted);
}

function sortByATA() {
  const sorted = [...currentData].sort((a, b) => a.ata.localeCompare(b.ata));
  showFaultList(sorted);
}

function resetSort() {
  showFaultList(currentData);
}

document.getElementById('search').addEventListener('input', e => {
  const val = e.target.value.toLowerCase();
  const filtered = currentData.filter(item =>
    item.code.toLowerCase().includes(val) ||
    item.title.toLowerCase().includes(val) ||
    item.description.toLowerCase().includes(val) ||
    item.cause.toLowerCase().includes(val) ||
    item.cb.toLowerCase().includes(val) ||
    item.ata.toLowerCase().includes(val)
  );
  showFaultList(filtered);
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

showAircraftSelect();
</script>

</body>
</html>
